(()=>{const S={countries:"/v1/countries",country:t=>`/v1/countries/${encodeURIComponent(t)}`,shipping:(t,e)=>`/v1/shipping/${encodeURIComponent(t)}/${encodeURIComponent(e)}`},P=15e3,j="NGN",G="en-NG";function I(t){return t?String(t).toLowerCase().replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"-"):""}function _(t=P){const e=new AbortController,n=setTimeout(()=>e.abort(),t);return{signal:e.signal,clear:()=>clearTimeout(n),controller:e}}async function A(t,{signal:e}={}){const o=await fetch(t,{method:"GET",headers:{Accept:"application/json"},signal:e});if(!o.ok){const s=await o.text().catch(()=>""),p=`Request failed (${o.status})`,u=new Error(p);throw u.status=o.status,u.body=s,u}return await o.json()}function y(t,e=j,n=G,o={}){if(t==null)return"";const a=Number(t);if(Number.isNaN(a))return"";const s={minimumFractionDigits:2,maximumFractionDigits:2,...o};try{return new Intl.NumberFormat(n,{style:"currency",currency:e,...s}).format(a)}catch{return`${e} ${a.toFixed(s.minimumFractionDigits)}`}}function f({value:t,text:e,dataset:n={}}){const o=document.createElement("option");return o.value=t,o.textContent=e,Object.keys(n).forEach(a=>o.dataset[a]=n[a]),o}const i={country:document.getElementById("country"),state:document.getElementById("state"),shippingMethodsContainer:document.getElementById("shipping_methods"),shippingFeeEl:document.getElementById("shipping_fee"),billingSameAsShipping:document.getElementById("billing_same_as_shipping"),billingFields:document.getElementById("billing_fields"),passwordFields:document.getElementById("password_fields"),termsAgreement:document.getElementById("terms_agreement"),submitButton:document.querySelector('button[type="submit"]'),subtotalEl:document.querySelector("[data-subtotal]")||null,totalEl:document.querySelector(".space-y-4 .font-semibold > span:last-child")||null,shippingAriaLive:function(){let t=document.querySelector("#shipping-status-live");return t||(t=document.createElement("div"),t.id="shipping-status-live",t.setAttribute("aria-live","polite"),t.className="sr-only",document.body.appendChild(t)),t}()};let F=null,r={countryFetch:null,stateFetch:null},c=null,D=null;(function(){const e=document.querySelector("[data-subtotal]")?.textContent||document.querySelector(".space-y-4 .text-black.opacity-60 + span")?.textContent||null;if(e){const n=e.replace(/[^\d.-]+/g,""),o=Number(n);D=Number.isFinite(o)?o:null}})();function b(t){const e=i.shippingMethodsContainer;if(e&&(e.setAttribute("aria-busy",t?"true":"false"),t)){e.innerHTML="";const n=document.createElement("p");n.className="text-sm text-black opacity-60",n.textContent="Loading shipping methods...",e.appendChild(n),i.shippingAriaLive.textContent="Loading shipping methods"}}function v(t){i.shippingMethodsContainer.innerHTML="";const e=document.createElement("div");e.className="text-sm text-red-600",e.textContent=t||"Could not load shipping methods. Please try again.",i.shippingMethodsContainer.appendChild(e),i.shippingAriaLive.textContent=t||"Error loading shipping methods"}function T(){i.shippingMethodsContainer.innerHTML="";const t=document.createElement("p");t.className="text-sm text-black opacity-60",t.textContent="Select your shipping method based on your location.",i.shippingMethodsContainer.appendChild(t)}function m(t){i.shippingFeeEl.textContent=t!==null?y(t):"TBD"}function C(){if(D===null)return;const t=c?.delivery_cost?Number(c.delivery_cost):0,e=D+t,n=i.totalEl;n&&(n.textContent=y(e))}function J(t){i.submitButton&&(i.submitButton.disabled=!t)}function d(){const t=i.termsAgreement?i.termsAgreement.checked:!0;J(t&&!!c)}function $(t){if(!i.country)return;i.country.innerHTML="";const e=i.country.dataset.old||"";i.country.dataset.old="",i.country.appendChild(f({value:"",text:"Select Country"})),t.forEach(n=>{const o=n.code??n.id??n.iso??"",a=n.name??n.title??o,s=f({value:o,text:a});i.country.appendChild(s)}),i.country.value=e,i.country.dispatchEvent(new Event("change"))}function w(t){if(!i.state)return;i.state.innerHTML="";const e=i.state.dataset.old||"";i.state.dataset.old="",i.state.appendChild(f({value:"",text:"Select State"})),!(!Array.isArray(t)||t.length===0)&&(t.forEach(n=>{const o=f({value:n.id??n.code??n.name??"",text:n.name??n.title??""});i.state.appendChild(o)}),i.state.value=e,i.state.dispatchEvent(new Event("change")))}function k(t,e){const n=new Date(t);let o=0;for(;o<e;){n.setDate(n.getDate()+1);const a=n.getDay();a!==0&&a!==6&&o++}return n}function B(t){return t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}function q(t){const e=i.shippingMethodsContainer;if(e.innerHTML="",!Array.isArray(t)||t.length===0){const a=document.createElement("div");a.className="text-sm text-black opacity-60",a.textContent="No shipping methods available for this country.",e.appendChild(a),c=null,m(null),C(),d();return}e.setAttribute("role","radiogroup"),e.setAttribute("aria-labelledby","shipping-methods-label");const n=new Date;t.forEach((a,s)=>{console.log(a,s);const p=a.id??a.code??`generated-${s}-${I(a.name)}`,u=String(a.name??`Method ${s+1}`),h=Number(a.delivery_cost??0),R=a.delivery_min_days??a.min_days??0,H=a.delivery_max_days??a.max_days??0,K=k(n,R),Q=k(n,H),U=`${B(K)} â€“ ${B(Q)}`,E=document.createElement("div");E.className="flex items-start py-2 border-b border-gray-100 last:border-b-0";const l=document.createElement("input");l.type="radio",l.id=`shipping-method-${I(p)}`,l.name="shipping_method",l.value=p,l.dataset.cost=String(h),l.required=!0,l.className="mt-1 mr-3 flex-shrink-0",l.addEventListener("change",X=>{c={id:p,name:u,delivery_cost:h,delivery_min_days:R,delivery_max_days:H},m(h),C(),d(),i.shippingAriaLive.textContent=`Selected ${u} ${y(h)}. Estimated delivery ${U}.`});const g=document.createElement("label");g.htmlFor=l.id,g.className="flex justify-between items-start w-full cursor-pointer";const x=document.createElement("div");x.className="flex flex-col space-y-1";const N=document.createElement("span");N.textContent=u,N.className="text-sm font-medium text-gray-900";const L=document.createElement("span");L.textContent=`Estimated delivery ${U}`,L.className="text-xs text-gray-500",x.appendChild(N),x.appendChild(L);const M=document.createElement("span");M.textContent=y(h),M.className="text-sm font-semibold text-gray-900 ml-auto",g.appendChild(x),g.appendChild(M),E.appendChild(l),E.appendChild(g),e.appendChild(E)});const o=e.querySelector('input[type="radio"]');o&&o.focus()}async function V(){if(F){$(F);return}const t=_();r.countryFetch=t.controller;try{const e=await A(S.countries,{signal:t.signal});if(!Array.isArray(e))throw new Error("Invalid countries response");F=e,$(e)}catch(e){console.error("Error fetching countries:",e),v("Unable to load countries. Please refresh the page or try again later.")}finally{t.clear(),r.countryFetch=null}}async function W(t){if(!t){w([]),T(),c=null,m(null),d();return}if(r.countryFetch)try{r.countryFetch.abort()}catch{}b(!0);const e=_();r.countryFetch=e.controller;try{const n=await A(S.country(t),{signal:e.signal}),o=Array.isArray(n.states)?n.states:[],a=Array.isArray(n.active_methods)?n.active_methods:[];w(o),q(a)}catch(n){console.error("Error fetching country details:",n),w([]),v("Could not load states/shipping for selected country.")}finally{b(!1),e.clear(),r.countryFetch=null,d()}}async function Y(t){if(!t){c=null,m(null),C(),d();return}if(r.stateFetch)try{r.stateFetch.abort()}catch{}b(!0);const e=_();r.stateFetch=e.controller;try{const n=await A(S.shipping("state",t),{signal:e.signal}),o=Array.isArray(n.active_methods)?n.active_methods:[];q(o)}catch(n){console.error("Error fetching state shipping:",n),v("Could not load shipping methods for selected state.")}finally{b(!1),e.clear(),r.stateFetch=null,d()}}function z(){i.billingSameAsShipping?.addEventListener("change",function(){i.billingFields&&i.billingFields.classList.toggle("hidden",this.checked)}),i.country?.addEventListener("change",function(){const e=this.value;i.state.innerHTML="",i.state.disabled=!0,W(e).finally(()=>{i.state.disabled=!1})}),i.state?.addEventListener("change",function(){const e=this.value;i.state.disabled=!0,Y(e).finally(()=>{i.state.disabled=!1})}),i.termsAgreement?.addEventListener("change",d),d();const t=document.querySelector("form");t&&t.addEventListener("submit",e=>{if(!c){e.preventDefault(),v("Please select a shipping method before continuing.");return}if(i.termsAgreement&&!i.termsAgreement.checked){e.preventDefault(),alert("Please accept Terms & Conditions to proceed.");return}t.querySelectorAll('input[name="selected_shipping_id"], input[name="selected_shipping_cost"]').forEach(s=>s.remove());const o=document.createElement("input");o.type="hidden",o.name="selected_shipping_id",o.value=c.id,t.appendChild(o);const a=document.createElement("input");a.type="hidden",a.name="selected_shipping_cost",a.value=c.delivery_cost,t.appendChild(a)})}function O(){T(),m(null),C(),z(),V()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",O):O()})();
